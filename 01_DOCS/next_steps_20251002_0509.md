# NVMe ETE Provision — Immediate Next Steps
Timestamp: 2025-10-02 05:09:28

This session integrated a refreshed `provision/ete_postcheck.sh` from user upload. Pending changes to ``python -m rp5.provision` (see docs/usage/provisioning.md)` are documented below for a flawless first boot.

## To apply next (surgical and minimal-risk)
1. Repair syntax & typos inside `provision/`python -m rp5.provision` (see docs/usage/provisioning.md)`:
   - Fix split token `eli f` → `elif` (if present).
   - Fix truncated `lsinitramfs /boo...` path to `/boot/initrd.img-$(uname -r)` probe.
   - Remove any stray `...` literals and mis-indented `_write_json_result(...)` calls.
2. Firmware sync and initramfs handoff:
   - Ensure `/boot/firmware` is **rsynced** into target (ESP content) before finishing.
   - After `update-initramfs`, copy active `/boot/initrd.img-$(uname -r)` to `/boot/firmware/initramfs8` (and/or `initramfs_2712` when present) **inside the target** root.
   - Add a single `initramfs <chosen> followkernel` line to `config.txt` (deduplicate first).
3. Validator hardening:
   - Confirm `cmdline.txt` contains exactly one `cryptdevice=UUID=<p3-uuid>:cryptroot` and one `root=/dev/mapper/rp5vg-root`.
   - Verify `crypttab` equals: `cryptroot UUID=<p3-uuid> none luks,discard`.
   - Verify `lsinitramfs` includes `cryptsetup` and `lvm` for the **active** kernel.
   - Verify `fstab` uses correct UUIDs for ESP and /boot.
4. Udev settling:
   - Add `udevadm settle --timeout=10` after `sgdisk/partprobe` and after `vgcreate/lvcreate`.
5. Discard policy clarity:
   - Prefer runtime `fstrim` (default). If `mount discard` is desired, add mount options in `/etc/fstab` or use `mkfs.ext4 -E discard` explicitly.
6. Doctor preflight (protects the USB host OS):
   - Print matrix: `lsblk -o NAME,TYPE,RM,ROTA,TRAN,MOUNTPOINTS`.
   - Fail fast when target and root device risk overlap is detected.
7. Integrate `ete_postcheck.sh` invocation:
   - At the end of provisioning, call it with env: `PASSFILE`, `MNT`, `DEV`, `VG`, `LV`, `RESULT_JSON=/var/log/ete_result.json`.
   - Treat non-zero exit as a hard fail.

## Recommended run sequence (after patching the Python provisioner)
```sh
sudo PASSFILE=~/secret.txt   python3 ~/rp5/provision/`python -m rp5.provision` (see docs/usage/provisioning.md) /dev/nvme0n1   `--yes` (full provision) --yes `--do-postcheck`
```

## Notes
- The provided `ete_postcheck.sh` (Build 20251002_0023) is executable and lives at `provision/ete_postcheck.sh`.
- This doc is additive; previous learnings remain intact.
